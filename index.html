<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Escolha sua cor</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f7fafc; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
    .container { width: 380px; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
    h2 { margin: 0 0 15px; font-size: 20px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select, button { width: 100%; padding: 10px; margin-top: 6px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; }
    button { background: #2d9cdb; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 15px; }
    .mensagem { margin-top: 10px; font-weight: bold; }
    .sucesso { color: green; }
    .erro { color: red; }
    .ocupadas { margin-top: 15px; font-size: 14px; }
    .linha { display: flex; align-items: center; gap: 8px; margin-top: 5px; }
    .swatch { width: 18px; height: 18px; border-radius: 4px; border: 1px solid #ccc; flex-shrink: 0; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Escolha sua cor</h2>

  <label for="nome">Nome</label>
  <input id="nome" type="text" placeholder="Digite seu nome ou nome do casal" />
  <div id="help-nome" style="font-size:12px;color:#666;margin-top:6px;font-style:italic">(casais usam a mesma cor)</div>

    <label for="cor">Cor</label>
    <select id="cor"><option value="">-- Escolha uma cor --</option></select>

    <button id="salvar" type="button">Salvar</button>
    <div id="mensagem" class="mensagem"></div>
    <div class="ocupadas">
      <strong>Cores ocupadas:</strong>
      <div id="lista-ocupadas"></div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
  import { getDatabase, ref, onValue, child, get, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // üî• Seu Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDS3Bn4X_ZktQG-jRLu4x58ubGlL16-zJc",
      authDomain: "bday-9da8b.firebaseapp.com",
      databaseURL: "https://bday-9da8b-default-rtdb.firebaseio.com",
      projectId: "bday-9da8b",
      storageBucket: "bday-9da8b.firebasestorage.app",
      messagingSenderId: "713551457375",
      appId: "1:713551457375:web:d76f0e404c33eeeeb6ffea",
      measurementId: "G-C6D3W2662E"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    let analytics = null;
    try {
      analytics = getAnalytics(app);
    } catch (e) {
      console.warn('Analytics init failed:', e);
    }
    const db = getDatabase(app);
    const auth = getAuth(app);
    let authed = false;

    // tenta login an√¥nimo automaticamente ‚Äî muitas regras permitem usu√°rios autenticados
    async function ensureAnonymousAuth() {
      if (auth.currentUser) {
        authed = true;
        return auth.currentUser;
      }
      try {
        const cred = await signInAnonymously(auth);
        authed = true;
        console.log('Autenticado anonimamente:', cred.user.uid);
        return cred.user;
      } catch (e) {
        console.warn('N√£o foi poss√≠vel autenticar anonimamente:', e);
        authed = false;
        throw e;
      }
    }

    onAuthStateChanged(auth, user => {
      authed = !!user;
      console.log('Auth state changed, authed=', authed, user && user.uid);
    });

    // tenta autenticar em background (n√£o bloqueia render)
    ensureAnonymousAuth().catch(() => {});

    // Lista de 13 cores
    const CORES = [
      { id: "vermelho",    label: "Vermelho",    hex: "#e74c3c" },
      { id: "azul",        label: "Azul",        hex: "#3498db" },
      { id: "verde",       label: "Verde",       hex: "#2ecc71" },
      { id: "amarelo",     label: "Amarelo",     hex: "#f1c40f" },
      { id: "roxo",        label: "Roxo",        hex: "#9b59b6" },
      { id: "laranja",     label: "Laranja",     hex: "#e67e22" },
      { id: "rosa",        label: "Rosa",        hex: "#fd79a8" },
      { id: "rosa-claro",  label: "Rosa claro",  hex: "#ffb6c1" },
      { id: "bege",        label: "Bege",        hex: "#f5f5dc" },
      { id: "ciano",       label: "Ciano",       hex: "#00ffff" },
      { id: "marrom",      label: "Marrom",      hex: "#8e5c42" },
      { id: "cinza",       label: "Cinza",       hex: "#7f8c8d" },
      { id: "preto",       label: "Preto",       hex: "#2c3e50" },
      { id: "branco",      label: "Branco",      hex: "#ecf0f1" },
      { id: "verde-escuro", label: "Verde escuro", hex: "#006400" },
      { id: "azul-escuro",  label: "Azul escuro",  hex: "#00008B" },
      { id: "arco-iris",    label: "Arco-√≠ris",    hex: "rainbow" }
    ];

    const selectCor = document.getElementById("cor");
    const btnSalvar = document.getElementById("salvar");
    const nomeInput = document.getElementById("nome");
    const mensagem = document.getElementById("mensagem");
    const listaOcupadas = document.getElementById("lista-ocupadas");

    function renderOptions(ocupadas) {
      selectCor.innerHTML = '<option value="">-- Escolha uma cor --</option>';
      CORES.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        // label + unavailable marker
        opt.textContent = c.label + (ocupadas[c.id] ? " (Indispon√≠vel)" : "");
        if (ocupadas[c.id]) opt.disabled = true;
        selectCor.appendChild(opt);
      });
    }

    function renderOcupadasList(ocupadas) {
      listaOcupadas.innerHTML = "";
      const keys = Object.keys(ocupadas);
      if (!keys.length) {
        listaOcupadas.textContent = "Nenhuma ainda.";
        return;
      }
      keys.forEach(k => {
        const info = CORES.find(c => c.id === k);
        const linha = document.createElement("div");
        linha.className = "linha";
        const sw = document.createElement("div");
        sw.className = "swatch";
        // suporte a swatch arco-√≠ris (gradiente)
        if (info && info.hex === 'rainbow') {
          sw.style.backgroundImage = 'linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet)';
        } else {
          sw.style.background = info ? info.hex : "#ccc";
        }
        const txt = document.createElement("div");
        // mostra label da cor e abaixo o nome de quem selecionou
        const label = document.createElement('div');
        label.textContent = info ? info.label : k;
        label.style.fontWeight = '600';
        const who = document.createElement('div');
        who.textContent = ocupadas[k];
        who.style.fontSize = '13px';
        who.style.color = '#222';
        who.style.marginTop = '2px';
        txt.appendChild(label);
        txt.appendChild(who);
        linha.appendChild(sw);
        linha.appendChild(txt);
        listaOcupadas.appendChild(linha);
      });
    }

    // Rendera op√ß√µes a partir da lista local de CORES (ser√£o atualizadas quando ler /selecoes)
    renderOptions({});

    // mapa de ocupadas: { colorId: nome }
    let ocupadas = {};

    // computa ocupadas a partir de entradas em /selecoes (primeiro ts vence)
    function computeOcupadasFromSelecoes(entries) {
      const map = {};
      Object.keys(entries || {}).forEach(k => {
        const e = entries[k];
        if (!e || !e.cor) return;
        const cor = e.cor;
        const ts = typeof e.ts === 'number' ? e.ts : (e.ts ? Number(e.ts) : Date.now());
        if (!map[cor] || ts < map[cor].ts) {
          map[cor] = { nome: e.nome || '‚Äî', ts };
        }
      });
      // convert to simple name map for renderOptions
      const simple = {};
      Object.keys(map).forEach(c => simple[c] = map[c].nome);
      return { detailed: map, simple };
    }

    async function attachSelecoesListener() {
      try {
        const selecoesRef = ref(db, 'selecoes');
        onValue(selecoesRef, snapshot => {
          const data = snapshot.val() || {};
          const { detailed, simple } = computeOcupadasFromSelecoes(data);
          ocupadas = simple;
          renderOptions(ocupadas);
          renderOcupadasList(ocupadas);
        }, async (err) => {
          console.warn('Erro ao escutar /selecoes:', err);
          // tenta fallback REST
          try {
            const base = firebaseConfig.databaseURL.replace(/\/$/, '');
            const url = base + '/selecoes.json';
            const resp = await fetch(url);
            if (resp.ok) {
              const data = await resp.json() || {};
              const { detailed, simple } = computeOcupadasFromSelecoes(data);
              ocupadas = simple;
              renderOptions(ocupadas);
              renderOcupadasList(ocupadas);
              return;
            }
          } catch (e) {
            console.warn('REST fallback /selecoes falhou:', e);
          }
          // se tudo falhar, mant√©m as op√ß√µes habilitadas
          ocupadas = {};
          renderOptions(ocupadas);
          renderOcupadasList(ocupadas);
        });
      } catch (e) {
        console.warn('N√£o foi poss√≠vel anexar listener /selecoes:', e);
      }
    }

    attachSelecoesListener();

    // Clique salvar
    btnSalvar.addEventListener("click", async () => {
      const nome = nomeInput.value.trim();
      const cor = selectCor.value;

      mensagem.className = "mensagem";
      if (!nome) {
        mensagem.textContent = "Digite seu nome.";
        mensagem.classList.add("erro");
        return;
      }
      if (!cor) {
        mensagem.textContent = "Escolha uma cor.";
        mensagem.classList.add("erro");
        return;
      }

      // verifica se a cor j√° est√° ocupada localmente
      if (ocupadas[cor]) {
        mensagem.textContent = 'Essa cor j√° foi selecionada por: ' + ocupadas[cor];
        mensagem.classList.add('erro');
        return;
      }

      // registra a sele√ß√£o em selecoes/<timestamp> sem bloquear a cor
      const ts = Date.now();
      const caminho = 'selecoes/' + ts;
      const payload = { nome, cor, ts };
      try {
        // garante autentica√ß√£o an√¥nima antes de usar SDK set
        try {
          await ensureAnonymousAuth();
        } catch (authErr) {
          console.warn('Auth an√¥nimo n√£o dispon√≠vel, continuar√° com REST fallback');
        }

        // tenta usar SDK set se estiver autenticado
        if (authed) {
          await set(ref(db, caminho), payload);
        } else {
          // se n√£o autenticado, tenta REST PUT (pode falhar com 401)
          const base = firebaseConfig.databaseURL.replace(/\/$/, '');
          const url = base + '/' + caminho + '.json';
          const resp = await fetch(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
        }

        mensagem.textContent = "Sele√ß√£o registrada!";
        mensagem.classList.add("sucesso");
        nomeInput.value = "";
        selectCor.value = "";
      } catch (err) {
        console.error('Erro ao salvar sele√ß√£o:', err);
        // mais contexto para o usu√°rio
        if (err && String(err).includes('401')) {
          mensagem.textContent = 'Falha ao salvar: sem permiss√£o (401). Verifique as regras do Firebase.';
        } else {
          mensagem.textContent = 'Falha ao salvar. Talvez sem permiss√£o ou sem conex√£o.';
        }
        mensagem.classList.add('erro');
      }
    });
  </script>
</body>
</html>
